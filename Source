local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local TweenService = game:GetService("TweenService")
local UserInputService = game:GetService("UserInputService")
local LocalPlayer = Players.LocalPlayer
local Camera = workspace.CurrentCamera

--[[ GLOBAL SETTINGS & CLEANUP ]]
local Cleanup = { Connections = {}, Instances = {} }
local Settings = {
    -- Visuals
    Box = false,
    Names = false,
    Tracers = false,
    Chams = false,
    -- Target Logic
    PlayerLock = false,
    ShowFOV = false,
    FOVSize = 150,
    -- Theme
    RGB = false,
    Theme = Color3.fromRGB(0, 255, 230), -- Default Cyan
    MenuOpen = true
}

local ColorPresets = {
    Color3.fromRGB(0, 255, 230), -- Cyan
    Color3.fromRGB(255, 60, 60), -- Red
    Color3.fromRGB(80, 255, 80), -- Green
    Color3.fromRGB(170, 80, 255), -- Purple
    Color3.fromRGB(255, 160, 0),  -- Orange
    Color3.fromRGB(255, 80, 180)  -- Pink
}
local currentColorIndex = 1
local LockedTarget = nil

--------------------------------------------------------------------------------
-- 1. UTILITY: SYSTEM LOGIC
--------------------------------------------------------------------------------
local function SelfDestruct()
    for _, conn in pairs(Cleanup.Connections) do if conn then conn:Disconnect() end end
    for _, instance in pairs(Cleanup.Instances) do if instance and instance.Parent then instance:Destroy() end end
    local gui = LocalPlayer:WaitForChild("PlayerGui"):FindFirstChild("GlassDashboardUI")
    if gui then gui:Destroy() end
    warn("SYSTEM: Self Destruct Complete.")
    script:Destroy()
end

local function GetClosestPlayerInFOV()
    local closest = nil
    local shortestDist = Settings.FOVSize
    local mousePos = UserInputService:GetMouseLocation()
    
    for _, player in pairs(Players:GetPlayers()) do
        if player ~= LocalPlayer and player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
            local root = player.Character.HumanoidRootPart
            local hum = player.Character:FindFirstChild("Humanoid")
            if hum and hum.Health > 0 then
                local pos, onScreen = Camera:WorldToViewportPoint(root.Position)
                if onScreen then
                    local dist = (Vector2.new(pos.X, pos.Y) - mousePos).Magnitude
                    if dist < shortestDist then
                        closest = player
                        shortestDist = dist
                    end
                end
            end
        end
    end
    return closest
end

--------------------------------------------------------------------------------
-- 2. UI HELPERS
--------------------------------------------------------------------------------
local function MakeSmartDraggable(guiObject)
    local dragging, dragInput, dragStart, startPos
    guiObject.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = true
            dragStart = input.Position
            startPos = guiObject.Position
            input.Changed:Connect(function() if input.UserInputState == Enum.UserInputState.End then dragging = false end end)
        end
    end)
    guiObject.InputChanged:Connect(function(input) if input.UserInputType == Enum.UserInputType.MouseMovement then dragInput = input end end)
    UserInputService.InputChanged:Connect(function(input)
        if input == dragInput and dragging then
            local delta = input.Position - dragStart
            guiObject.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
        end
    end)
end

local function UpdateTheme(newColor)
    Settings.Theme = newColor
    local gui = LocalPlayer:WaitForChild("PlayerGui"):FindFirstChild("GlassDashboardUI")
    if not gui then return end
    
    -- Update Glow/Shadow
    gui.Shadow.ImageColor3 = newColor
    
    local frame = gui.Shadow.MainFrame
    frame.UIStroke.Color = newColor
    frame.Title.TextColor3 = newColor
    if gui:FindFirstChild("FOVCircle") then gui.FOVCircle.UIStroke.Color = newColor end
    
    for _, obj in pairs(frame:GetDescendants()) do
        if obj:IsA("TextButton") and obj:GetAttribute("IsActive") then
            -- Active Buttons Glow with Theme
            obj.TextColor3 = newColor
            obj.BackgroundColor3 = newColor
            obj.BackgroundTransparency = 0.8 -- Glassy Active State
            obj.UIStroke.Color = newColor
        elseif obj:IsA("TextButton") and not obj:GetAttribute("IsActive") then
            -- Inactive Buttons Reset
            obj.UIStroke.Color = Color3.fromRGB(100, 100, 100)
        end
        
        if obj.Name == "Fill" then obj.BackgroundColor3 = newColor end
        if obj.Name == "Header" then obj.TextColor3 = newColor end
    end
end

--------------------------------------------------------------------------------
-- 3. UI CONSTRUCTION (GLASS STYLE)
--------------------------------------------------------------------------------
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "GlassDashboardUI"
screenGui.ResetOnSpawn = false
screenGui.Parent = LocalPlayer:WaitForChild("PlayerGui")

-- FOV Circle
local fovCircle = Instance.new("Frame")
fovCircle.Name = "FOVCircle"
fovCircle.AnchorPoint = Vector2.new(0.5, 0.5)
fovCircle.Position = UDim2.new(0.5, 0, 0.5, 0)
fovCircle.Size = UDim2.new(0, Settings.FOVSize*2, 0, Settings.FOVSize*2)
fovCircle.BackgroundTransparency = 1
fovCircle.Visible = false
fovCircle.Parent = screenGui
local fStroke = Instance.new("UIStroke")
fStroke.Color = Settings.Theme
fStroke.Thickness = 2
fStroke.Parent = fovCircle
Instance.new("UICorner", fovCircle).CornerRadius = UDim.new(1, 0)

-- === GLASS DASHBOARD ===
local shadow = Instance.new("ImageLabel")
shadow.Name = "Shadow"
shadow.Size = UDim2.new(0, 500, 0, 400)
shadow.Position = UDim2.new(0.5, -250, 0.5, -200)
shadow.BackgroundTransparency = 1
shadow.Image = "rbxassetid://6014261993"
shadow.ImageColor3 = Settings.Theme -- Neon Glow
shadow.ImageTransparency = 0.6
shadow.ScaleType = Enum.ScaleType.Slice
shadow.SliceCenter = Rect.new(49, 49, 450, 450)
shadow.Parent = screenGui

local mainFrame = Instance.new("Frame")
mainFrame.Name = "MainFrame"
mainFrame.Size = UDim2.new(0, 460, 0, 360)
mainFrame.Position = UDim2.new(0.5, -230, 0.5, -180)
-- GLASS PROPERTY: Dark but transparent
mainFrame.BackgroundColor3 = Color3.fromRGB(15, 15, 20)
mainFrame.BackgroundTransparency = 0.25 
mainFrame.BorderSizePixel = 0
mainFrame.Parent = shadow

Instance.new("UICorner", mainFrame).CornerRadius = UDim.new(0, 12)

-- Glass Edge Effect
local mStroke = Instance.new("UIStroke")
mStroke.Color = Settings.Theme
mStroke.Thickness = 1.5
mStroke.Transparency = 0.3
mStroke.Parent = mainFrame

MakeSmartDraggable(shadow)

-- Title
local title = Instance.new("TextLabel")
title.Name = "Title"
title.Text = "MISC TOOLS // GLASS"
title.Size = UDim2.new(1, -20, 0, 40)
title.Position = UDim2.new(0, 20, 0, 0)
title.BackgroundTransparency = 1
title.TextColor3 = Settings.Theme
title.Font = Enum.Font.GothamBlack
title.TextSize = 20
title.TextXAlignment = Enum.TextXAlignment.Left
title.Parent = mainFrame

-- === COMPONENT GENERATORS ===

local function createHeader(text, xPos, yPos)
    local l = Instance.new("TextLabel")
    l.Name = "Header"
    l.Text = text
    l.Size = UDim2.new(0, 200, 0, 20)
    l.Position = UDim2.new(0, xPos, 0, yPos)
    l.BackgroundTransparency = 1
    l.TextColor3 = Settings.Theme
    l.Font = Enum.Font.GothamBold
    l.TextSize = 12
    l.TextXAlignment = Enum.TextXAlignment.Left
    l.TextTransparency = 0.1
    l.Parent = mainFrame
end

local function createToggle(text, xPos, yPos, settingKey)
    local btn = Instance.new("TextButton")
    btn.Size = UDim2.new(0, 200, 0, 32)
    btn.Position = UDim2.new(0, xPos, 0, yPos)
    -- GLASS BUTTON: Transparent
    btn.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
    btn.BackgroundTransparency = 0.95
    btn.Text = text
    btn.TextColor3 = Color3.fromRGB(200, 200, 200)
    btn.Font = Enum.Font.GothamBold
    btn.TextSize = 14
    btn.AutoButtonColor = false
    btn.Parent = mainFrame
    Instance.new("UICorner", btn).CornerRadius = UDim.new(0, 6)
    
    local btnStroke = Instance.new("UIStroke")
    btnStroke.Color = Color3.fromRGB(100, 100, 100)
    btnStroke.Thickness = 1
    btnStroke.Transparency = 0.5
    btnStroke.Parent = btn
    
    btn.MouseButton1Click:Connect(function()
        Settings[settingKey] = not Settings[settingKey]
        local isActive = Settings[settingKey]
        btn:SetAttribute("IsActive", isActive)
        
        local targetCol = isActive and Settings.Theme or Color3.fromRGB(200, 200, 200)
        local targetBgTrans = isActive and 0.8 or 0.95 -- More visible when active
        local targetBg = isActive and Settings.Theme or Color3.fromRGB(255, 255, 255)
        local targetStroke = isActive and Settings.Theme or Color3.fromRGB(100, 100, 100)

        TweenService:Create(btn, TweenInfo.new(0.2), {
            TextColor3 = targetCol, 
            BackgroundColor3 = targetBg,
            BackgroundTransparency = targetBgTrans
        }):Play()
        
        btnStroke.Color = targetStroke
        
        if settingKey == "ShowFOV" then fovCircle.Visible = Settings.ShowFOV end
    end)
end

local function createSlider(text, xPos, yPos, min, max, default, callback)
    local bg = Instance.new("TextButton")
    bg.Text = ""
    bg.Size = UDim2.new(0, 200, 0, 25)
    bg.Position = UDim2.new(0, xPos, 0, yPos + 20)
    bg.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
    bg.BackgroundTransparency = 0.5
    bg.AutoButtonColor = false
    bg.Parent = mainFrame
    Instance.new("UICorner", bg).CornerRadius = UDim.new(0, 4)
    
    local sStroke = Instance.new("UIStroke")
    sStroke.Color = Color3.fromRGB(80, 80, 80)
    sStroke.Transparency = 0.5
    sStroke.Parent = bg
    
    local fill = Instance.new("Frame")
    fill.Name = "Fill"
    fill.Size = UDim2.new((default-min)/(max-min), 0, 1, 0)
    fill.BackgroundColor3 = Settings.Theme
    fill.BorderSizePixel = 0
    fill.BackgroundTransparency = 0.2
    fill.Parent = bg
    Instance.new("UICorner", fill).CornerRadius = UDim.new(0, 4)
    
    local label = Instance.new("TextLabel")
    label.Text = text .. ": " .. default
    label.Size = UDim2.new(1, 0, 0, 20)
    label.Position = UDim2.new(0, 0, 0, -20)
    label.BackgroundTransparency = 1
    label.TextColor3 = Color3.fromRGB(200, 200, 200)
    label.Font = Enum.Font.GothamMedium
    label.TextSize = 12
    label.TextXAlignment = Enum.TextXAlignment.Left
    label.Parent = bg
    
    local dragging = false
    bg.InputBegan:Connect(function(input) if input.UserInputType == Enum.UserInputType.MouseButton1 then dragging = true end end)
    UserInputService.InputEnded:Connect(function(input) if input.UserInputType == Enum.UserInputType.MouseButton1 then dragging = false end end)
    RunService.RenderStepped:Connect(function()
        if dragging then
            local pos = math.clamp((UserInputService:GetMouseLocation().X - bg.AbsolutePosition.X) / bg.AbsoluteSize.X, 0, 1)
            fill.Size = UDim2.new(pos, 0, 1, 0)
            local val = math.floor(min + (max-min)*pos)
            label.Text = text .. ": " .. val
            callback(val)
        end
    end)
end

-- === LAYOUT ===
local LEFT_X = 20
local RIGHT_X = 240
local Y_START = 50

-- Left
createHeader("TARGETING", LEFT_X, Y_START)
createToggle("Player Lock", LEFT_X, Y_START + 30, "PlayerLock")
createToggle("Show FOV Circle", LEFT_X, Y_START + 70, "ShowFOV")
createSlider("FOV Radius", LEFT_X, Y_START + 110, 50, 500, 150, function(v) 
    Settings.FOVSize = v 
    fovCircle.Size = UDim2.new(0, v*2, 0, v*2)
end)

-- Right
createHeader("VISUALS", RIGHT_X, Y_START)
createToggle("Box ESP", RIGHT_X, Y_START + 30, "Box")
createToggle("Tracers", RIGHT_X, Y_START + 70, "Tracers")
createToggle("Show Names", RIGHT_X, Y_START + 110, "Names")
createToggle("Chams (Fill)", RIGHT_X, Y_START + 150, "Chams")

-- Bottom
local BOTTOM_Y = 240
createHeader("SYSTEM", LEFT_X, BOTTOM_Y)
createToggle("RGB Mode", LEFT_X, BOTTOM_Y + 30, "RGB")

local cycBtn = Instance.new("TextButton")
cycBtn.Size = UDim2.new(0, 200, 0, 32)
cycBtn.Position = UDim2.new(0, RIGHT_X, 0, BOTTOM_Y + 30)
cycBtn.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
cycBtn.BackgroundTransparency = 0.95
cycBtn.Text = "Cycle Theme Color"
cycBtn.TextColor3 = Color3.fromRGB(200, 200, 200)
cycBtn.Font = Enum.Font.GothamBold
cycBtn.TextSize = 14
cycBtn.Parent = mainFrame
Instance.new("UICorner", cycBtn).CornerRadius = UDim.new(0, 6)
local cStroke = Instance.new("UIStroke")
cStroke.Color = Color3.fromRGB(100, 100, 100)
cStroke.Transparency = 0.5
cStroke.Parent = cycBtn

cycBtn.MouseButton1Click:Connect(function()
    currentColorIndex = (currentColorIndex % #ColorPresets) + 1
    Settings.RGB = false
    UpdateTheme(ColorPresets[currentColorIndex])
end)

-- DESTROY BUTTON
local destBtn = Instance.new("TextButton")
destBtn.Size = UDim2.new(0, 420, 0, 30)
destBtn.Position = UDim2.new(0.5, -210, 1, -40)
destBtn.BackgroundColor3 = Color3.fromRGB(255, 50, 50)
destBtn.BackgroundTransparency = 0.8
destBtn.Text = "SELF DESTRUCT (UNLOAD)"
destBtn.TextColor3 = Color3.fromRGB(255, 100, 100)
destBtn.Font = Enum.Font.GothamBold
destBtn.TextSize = 12
destBtn.Parent = mainFrame
Instance.new("UICorner", destBtn).CornerRadius = UDim.new(0, 6)
local dStroke = Instance.new("UIStroke")
dStroke.Color = Color3.fromRGB(255, 50, 50)
dStroke.Parent = destBtn

destBtn.MouseButton1Click:Connect(function()
    destBtn.Text = "GOODBYE..."
    task.wait(0.2)
    SelfDestruct()
end)

--------------------------------------------------------------------------------
-- 4. LOGIC
--------------------------------------------------------------------------------
UserInputService.InputBegan:Connect(function(input, gameProcessed)
    if input.KeyCode == Enum.KeyCode.RightShift then
        Settings.MenuOpen = not Settings.MenuOpen
        shadow.Visible = Settings.MenuOpen
    end
end)

local function createVisuals(player)
    if player == LocalPlayer then return end
    
    local function charAdded(character)
        if not character.Parent then character.AncestryChanged:Wait() end
        local root = character:WaitForChild("HumanoidRootPart", 10)
        local head = character:WaitForChild("Head", 10)
        if not root or not head then return end
        
        -- ESP SETUP
        local hl = Instance.new("Highlight")
        hl.FillTransparency = 0.6
        hl.DepthMode = Enum.HighlightDepthMode.AlwaysOnTop
        hl.Parent = character
        table.insert(Cleanup.Instances, hl)

        local bb = Instance.new("BillboardGui")
        bb.Adornee = root
        bb.Size = UDim2.new(4,0,5.5,0)
        bb.AlwaysOnTop = true
        bb.Parent = root
        table.insert(Cleanup.Instances, bb)
        local box = Instance.new("Frame", bb)
        box.Size = UDim2.new(1,0,1,0)
        box.BackgroundTransparency = 1
        local stroke = Instance.new("UIStroke", box)
        stroke.Thickness = 1.5

        local nameBb = Instance.new("BillboardGui")
        nameBb.Adornee = head
        nameBb.Size = UDim2.new(0, 200, 0, 30)
        nameBb.StudsOffset = Vector3.new(0, 3, 0)
        nameBb.AlwaysOnTop = true
        nameBb.Parent = head
        table.insert(Cleanup.Instances, nameBb)
        local nameLbl = Instance.new("TextLabel", nameBb)
        nameLbl.Size = UDim2.new(1,0,1,0)
        nameLbl.BackgroundTransparency = 1
        nameLbl.Text = player.Name
        nameLbl.TextColor3 = Color3.new(1,1,1)
        nameLbl.Font = Enum.Font.GothamBold
        nameLbl.TextSize = 14
        nameLbl.TextStrokeTransparency = 0.5
        
        local attach = Instance.new("Attachment", root)
        table.insert(Cleanup.Instances, attach)
        local beam = Instance.new("Beam")
        beam.Attachment1 = attach
        beam.FaceCamera = true
        beam.Width0, beam.Width1 = 0.1, 0.1
        beam.Transparency = NumberSequence.new(0.2)
        beam.Parent = root
        table.insert(Cleanup.Instances, beam)

        local conn
        conn = RunService.RenderStepped:Connect(function()
            if not character.Parent then conn:Disconnect() return end
            
            local isTarget = (player == LockedTarget)
            local color = isTarget and Color3.new(1,1,1) or Settings.Theme
            
            hl.Enabled = Settings.Chams
            hl.FillColor = color
            hl.OutlineColor = color
            
            bb.Enabled = Settings.Box
            stroke.Color = color
            nameBb.Enabled = Settings.Names
            
            if isTarget and Settings.PlayerLock then
                beam.Enabled = true
                beam.Color = ColorSequence.new(Color3.new(1,1,1))
            else
                beam.Enabled = Settings.Tracers
                beam.Color = ColorSequence.new(Settings.Theme)
            end
            
            if beam.Enabled and LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart") then
                local myAttach = LocalPlayer.Character.HumanoidRootPart:FindFirstChild("MenuBeamAttach")
                if not myAttach then
                    myAttach = Instance.new("Attachment", LocalPlayer.Character.HumanoidRootPart)
                    myAttach.Name = "MenuBeamAttach"
                    table.insert(Cleanup.Instances, myAttach)
                end
                beam.Attachment0 = myAttach
            end
        end)
        table.insert(Cleanup.Connections, conn)
    end
    if player.Character then charAdded(player.Character) end
    local conn = player.CharacterAdded:Connect(charAdded)
    table.insert(Cleanup.Connections, conn)
end

-- RENDER LOOP
local loop = RunService.RenderStepped:Connect(function()
    if Settings.PlayerLock then
        LockedTarget = GetClosestPlayerInFOV()
    else
        LockedTarget = nil
    end
    if Settings.RGB then
        local hue = tick() % 5 / 5
        UpdateTheme(Color3.fromHSV(hue, 1, 1))
    end
end)
table.insert(Cleanup.Connections, loop)

for _, p in pairs(Players:GetPlayers()) do createVisuals(p) end
local pAdded = Players.PlayerAdded:Connect(createVisuals)
table.insert(Cleanup.Connections, pAdded)
